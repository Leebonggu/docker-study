# Docker

## 1 가상화 기술

- 컨테이너
  - 큰 서버를 나눠서 사용하기 위한 가상화 기술
- 하이퍼바이저 vs 컨테이너
  - 도커는 컨테이너 방식으 ㅣ일정

## 애플리케이션 서버

- 하드웨어 + 하드웨어에서 사용하는 소프트웨어
- 일반적으로 하드웨어에서 실행중인 소프트웨어를 의미
- Serve
  - 넘겨주다.
- 클라이언트 <> 서버
  - 요청
    - 클라이언트가 보냄
  - 요청에 대한 응답
- 파일서버
  - 파일공유
- DB서버
  - 데이터 제공
- 웹서버(WEB)
  - 클라이언트가 HTTP요청을 보내면, 정 적 웹페이지를 제공해주는 서버
  - 웹페이지 제공
- 웹애플리케이션서버(WAS)
- 서버 운영
  - 베어메탈
    - 컴퓨터 구매하고, 사용하는 방식과 비슷
    - 서버구매 -> OS설치 -> 서비스 운영
  - 하이퍼바이저
  - 컨테이너
    - 도커는 여기에 해당

## 가상화 기술

- 가상
  - 존재하지 않지만, 존재하는 것처럼 느껴지는 것
- 큰 서버를 나눠서 사용할 수 있는 기술
- 가상 = 존재하지 않지만, 존재하는 것처럼 만들어진것
- 가상화 기술을 사용하면, 하나의 컴퓨터에서 여러개의 컴퓨터를 실행 가능
- 컴퓨터 안에서 컴퓨터를 실행하는 기술
- 논리적 컴퓨팅 환경
- 물리적인 컴퓨팅 환경에서 논리적인 컴퓨팅 환경을 만드는 것
- 사용하는 이유
  - 논리적으로 구분되어있기 떄문에 서로 독립적인 환경에서 운영가능

### 하이퍼바이저(전통적)

- 서버 -> 가상환경1, 가상환경2, 가상환경3
- 컴퓨터에서 실행되는 프로그램
- 프로그램을 통해 가상환경을 만들 수 있음
- 물리적 서버 = 호스트 OS
  - 하이퍼바이저 설치해서 가상환경을 실행
    - 가상머신
      - 게스트OS -> 가상머신 이라고 함
        - 프로세스
- 서버
  - 호스트OS
    - 커널 - 하트웨어와 소통하는 창구 (System Call)
      - 프로세스
- 하이퍼바이저
  - 서로 다른 기종 커널 간 요청전달가능
  - 가상머신 리소스 할당량 관리

### 컨테이너(도커)

- 하이퍼 바이저보다 더 선호되고 있음
- 커널의 자체 기술을 사용한 방식
- 하이퍼바이저에 비해 가볍고 빠름
  - 부팅속도가 빠르고
  - 오버헤드가 적음 (거치는 단계)
- 리눅스 자체의 격리 기술 사용
  - Namespace: 리소스를 나누는 기준으로 사용
  - Cgroups: 리소스 사용량 배분 기준
  - 컨테이너: 각각 만들어진 공간
  - 호스트OS의 커널을 공유
- 도커
  - 커널의 컨테이너 가상화 기술을 간편하게 사용하는 방법
  - 도커를 통해 컨테이너를 만들고, 운영가능
  - 도커는 커널의 가상화 기술을 사용할 수 있게 하는 도구

### 도커

- 컨테이너 가상화를 사용하기 위한 도구
- 컨테이너 플랫폼이라고 부름
  - 컨테이너 엔진 - 사용자 요청을 받아서 컨테이너 관리
  - 컨테이너 런타임 - 커널과 통신하며 컨테이너를 만드는 역할
- 도커 > 클라이언트 서버 모델로 실행됨
  - 클라이언트
    - 명령어 실행 -> CLI
    - 요청 전달
  - API
    - Docker CLI를 통해 간단한 명령어를 통해 대신 요청을 수행
      - ex) docker ps
  - 도커데몬
    - 컨테이너 관리
    - 결과 전달
  - 클라이언트 <> API <> 도커데몬 <> 호스트 OS <> 컨테이너 관리
    - API 파악하고 요청하기엔 시간이 오래걸림 -> CLI
    - 명령어 <> 서버API로 변환 <> 도커데몬

## 2. 이미지 + 라이프 사이클

- 이미지 - 컨테이너를 만드는 재료
  - 하드웨어 -> 소프트웨어 -> 다운로드/개발
    - 소프트웨어 실행을 위해서는
      - 하드웨어 자원을 사용하기 위한 OS필요
      - 실행에 필요한 언어 및 라이브러리, 설정 구성 필요
  - 이미지
    - 특정 시점의 파일시스템을 저장한 압축 파일
    - 소프트웨어를 실행을 위한 모든 요소를 압축해서 저장

### 이미지/컨테이너

- 프로그램과 프로세스
  - 프로그램은 디스크 공간만 활용
  - 프로그램을 사용하면 프로세스가 된다.
  - 각 프로세스들은 cpu, memory를 사용
    - 프로그램을 실행한 상태를 프로세스
- 이미지는 프로그램
- 컨테이너는 프로세스
  - 컨테이너는 가상화 기술이기 떄문에 격리된 공간에서 실행
- docker image ls (이미지명)
- docker run -d --name 컨테이너명 이미지명
- docker rm {{컨테이너명}} -f

### 이미지 메타데이터

- 데이터의 데이터
- 이미지의 이름/크기에 대한 정보
- docker image inspect {{이미지명}}
  - docker container inspect {{컨테이너명}}

### 컨테이너 라이프 사이클

- 이미지 -> (생성) -> 실행
  -> 종료
  -> 일시정지
  -> 삭제
- docker logs {{컨테이너명}}

## 이미지 레지스트리

- 도커 이미지 저장소(도커허브)
- 이미지 공유하거나, 필요한 이미지 다운로드 가능
- 이미지 공유, 검색, 버전관리, 보안. 파이프라인
- 저장공간
  - 호스트 머신의 로컬스토리지
  - 프라이빗 레지스트리
  - 퍼블릿 레지스트리
- 시작 명령어
  - 로컬스토리지의 이미지 검색
  - 로컬에 없으면 온라면 레지스트리에서 로컬로 다운로드 및 시작
- 프라이빗 레지스트리
  - 직접설치, 도커 -> 서버에 직접 설치
  - ECR, ACR
- 이미지 네이밍 규칙
  - 레지스트리주소/프로젝트명/이미지명:이미지태그
  - 레지스트리주소 기본값: 도커허브
  - 이미지태그 기본값: latest
  - 도커가 인증한 이미지의 경우, 라이브러리명 생략가능

## 이미지 빌드

### 이미지와 레이어

- 레이어 구조는 변경에 유리함
- 레이어 구조는 재사용에 유리함

### 이미지 레이어

- 이미지의 레이어는 이전 레이어의 변경 사항이 저장됨
- ex) nginx
  - os -> nginx 설치 -> nginx 설정 -> index.html
  - 기존 레이어에 변경된 사항이 새롭게 만들어짐
- 이미지에서 한번 저장된 레이어는 변경되지 않음

### 실행

- 이미지 레이어 => 읽기 전용 레이어
- 컨테이너 레이어 => 읽기/쓰기 레이어
  - 이미지를 실행하면, 컨터이너 레이어에서 실행됨

### IaC

- 코드로 이미지를 관리하는것이 이미지 빌드
- 코드로 인프라의 상태를 관리
- 변경사항 관리도 용이
- 도커에게 작업할 내용을 작성해서 줌: Dockerfile
- `docker build -t 이미지명 Dockerfile 경로`
- 명령어
  - 지시어 + 옵션값으로 구성
  - 기본 FROM, COPY , CMD
  - FROM
    - 베이스 이미지를 지정
  - COPY
    - 파일을 레이어에 복사
  - CMD
    - 컨테이너 실행 시 명령어 지정

### 빌드 컨텍스트

- 빌드에 사용하는 폴더
- 도커 데몬에 전달해주는 폴더가 빌드 컨텍스트

### 멀티 스테이징 빌드

- 빌드중에 생상되는 파일과, 실제 빌드에 사용되는 파일을 분리
